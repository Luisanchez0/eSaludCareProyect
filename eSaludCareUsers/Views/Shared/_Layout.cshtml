<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Mi aplicación ASP.NET</title>
    @Styles.Render("~/Content/css")
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
d
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>

<body class="index-page">

    <header id="header" class="header d-flex align-items-center fixed-top">
        <div class="container position-relative d-flex align-items-center justify-content-between">

            <a href="@Url.Action("Index","Home")" class="logo d-flex align-items-center me-auto me-xl-0">
                <h1 class="sitename">eSalud<span>Care</span></h1>
            </a>

            <nav id="navmenu" class="navmenu">
                <ul>
                    <li><a href="@Url.Action("Index", "Home")" class="active"><b>Inicio</b></a></li>
                    <li><a href="@Url.Action("Departamentos","Home")"><b>Especialidades</b></a></li>
                    <li><a href="@Url.Action("Servicios", "Home")"><b>Servicios</b></a></li>
                    <!---<li><a href="abour.html"><b>Médicos</b></a></li>-->
                    <li><a href="@Url.Action("Contacto", "Home")"><b>Contacto</b></a></li>
                </ul>
                <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
            </nav>

            <!-- Bloque de usuario dinámico -->
            <div id="user-section" class="dropdown">
                <!-- Botón de login -->
                <a id="btnLogin" class="btn-getstarted" href="@Url.Action("Index","Login")">Iniciar Sesión</a>

                <!-- Dropdown de usuario -->
                <a id="userDropdown" class="btn-getstarted dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="display:none;">
                    <span id="user-name"></span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="@Url.Action("Index","PerfilPaciente")">Perfil</a></li>
                    <li><a class="dropdown-item" href="@Url.Action("MisCitas","Citas")">Mis Citas</a></li>
                    <li><a class="dropdown-item" href="@Url.Action("Index","HistorialMedico")">Mi Historial Médico</a></li>
                    <li><a class="dropdown-item" href="@Url.Action("CambiaContrasena", "Home")">Cambiar Contraseña</a></li>

                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" id="btnLogout">Cerrar sesión</a></li>
                </ul>
            </div>

        </div>
    </header>

    <main class="main">
        @RenderBody()
    </main>


    <footer id="footer" class="footer position-relative">

        <div class="container footer-top">
            <div class="row gy-4">

                <!-- Información principal -->
                <div class="col-lg-4 col-md-6 footer-about">
                    <a href="index.html" class="logo d-flex align-items-center">
                        <span class="sitename">eSaludCare</span>
                    </a>
                    <div class="footer-contact pt-3">
                        <p>FOVISSSTE II Jardín Corona</p>
                        <p>Tuxtla Gutiérrez, Chiapas 29024</p>
                        <p class="mt-3"><strong>Teléfono:</strong> <span>+52 961 612 1044</span></p>
                        <p><strong>Email:</strong> <span>eSaludCare@salud.org</span></p>
                    </div>
                    <div class="social-links d-flex mt-4">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-x-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>

                <!-- Enlaces útiles -->
                <div class="col-lg-2 col-md-3 footer-links">
                    <h4>Enlaces útiles</h4>
                    <ul>
                        <li><a href="#">Inicio</a></li>
                        <li><a href="#">Nosotros</a></li>
                        <li><a href="#">Servicios</a></li>
                        <li><a href="#">Términos de servicio</a></li>
                        <li><a href="#">Política de privacidad</a></li>
                    </ul>
                </div>

                <!-- Especialidades -->
                <div class="col-lg-3 col-md-3 footer-links">
                    <h4>Especialidades</h4>
                    <ul>
                        <li><a href="#">Cardiología</a></li>
                        <li><a href="#">Pediatría</a></li>
                        <li><a href="#">Neurología</a></li>
                        <li><a href="#">Odontología</a></li>
                        <li><a href="#">Ginecología</a></li>
                    </ul>
                </div>

                <!-- Información adicional -->
                <div class="col-lg-3 col-md-3 footer-links">
                    <h4>Atención al paciente</h4>
                    <ul>
                        <li><a href="#">Emergencias 24/7</a></li>
                        <li><a href="#">Citas médicas</a></li>
                        <li><a href="#">Laboratorios</a></li>
                        <li><a href="#">Farmacia</a></li>
                        <li><a href="#">Contacto</a></li>
                    </ul>
                </div>

            </div>
        </div>

        <div class="container copyright text-center mt-4">
            <p>© <span>@DateTime.Now.Year</span> <strong class="sitename">eSaludCare</strong>. <span>Todos los derechos reservados.</span></p>
        </div>

    </footer>

    <!-- Scroll Top -->
    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

    <!-- Preloader -->
    <div id="preloader"></div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/complemento")
    @Scripts.Render("~/bundles/bootstrap")
    @Scripts.Render("~/bundles/jqueryval")
    @RenderSection("scripts", required: false)

    <!-- Bootstrap JS necesario para dropdown -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const token = localStorage.getItem("token");
            const nombre = localStorage.getItem("nombre");

            const loginBtn = document.getElementById("btnLogin");
            const userDropdown = document.getElementById("userDropdown");
            const userName = document.getElementById("user-name");
            const logoutBtn = document.getElementById("btnLogout");

            // --- Verifica expiración del token ---
            function isTokenExpired(token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return Date.now() >= payload.exp * 1000;
                } catch {
                    return true;
                }
            }

            // --- Control de autenticación visual ---
            if (token && nombre && !isTokenExpired(token)) {
                // Usuario autenticado
                loginBtn.style.display = "none";
                userDropdown.style.display = "inline-block";
                userName.textContent = "Hola " + nombre;

                // Si está en la página de login, lo redirige al inicio
                if (window.location.pathname.toLowerCase().includes("/login")) {
                    window.location.href = "/Home/Index";
                }
            } else {
                // Usuario no autenticado
                loginBtn.style.display = "inline-block";
                userDropdown.style.display = "none";
                localStorage.removeItem("token");
                localStorage.removeItem("nombre");
            }

            // --- Cerrar sesión ---
            logoutBtn?.addEventListener("click", function (e) {
                e.preventDefault();

                // Limpieza completa del almacenamiento
                localStorage.clear();
                sessionStorage.clear();

                // Limpieza de cookies (si las hay)
                document.cookie.split(";").forEach(c => {
                    document.cookie = c
                        .replace(/^ +/, "")
                        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });

                console.log("🧹 Se ha limpiado el localStorage, sessionStorage y cookies.");

                // Redirigir al login
                window.location.href = "/Login/Index";
            });
        });
    </script>

    <script src="https://bootstrapmade.com/assets/js/demo.js?v=106"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P7JSYB1CSP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-P7JSYB1CSP');
    </script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015"
            integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ=="
            data-cf-beacon='{"version":"2024.11.0","token":"68c5ca450bae485a842ff76066d69420"}'
            crossorigin="anonymous"></script>

</body>
</html>
