<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Mi aplicación ASP.NET</title>
    @Styles.Render("~/Content/css")
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>

<body class="index-page">

    <header id="header" class="header d-flex align-items-center fixed-top">
        <div class="container position-relative d-flex align-items-center justify-content-between">

            <a href="@Url.Action("Index","Home")" class="logo d-flex align-items-center me-auto me-xl-0">
                <h1 class="sitename">eSalud<span>Care</span></h1>
            </a>

            <nav id="navmenu" class="navmenu">
                <ul>
                    <li><a href="@Url.Action("Index", "Home")" class="active">Inicio</a></li>
                    <li><a href="@Url.Action("Departamentos","Home")">Áreas</a></li>
                    <li><a href="doctores.html">Servicios</a></li>
                    <li><a href="abour.html">Médicos</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
                <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
            </nav>

            <!-- Bloque de usuario dinámico -->
            <div id="user-section" class="dropdown">
                <!-- Botón de login -->
                <a id="btnLogin" class="btn-getstarted" href="@Url.Action("Index","Login")">Iniciar Sesión</a>

                <!-- Dropdown de usuario -->
                <a id="userDropdown" class="btn-getstarted dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="display:none;">
                    <span id="user-name"></span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="/Perfil">Perfil</a></li>
                    <li><a class="dropdown-item" href="@Url.Action("MisCitas","Citas")">Mis Citas</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" id="btnLogout">Cerrar sesión</a></li>
                </ul>
            </div>

        </div>
    </header>

    <main class="main">
        @RenderBody()
    </main>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/complemento")
    @Scripts.Render("~/bundles/bootstrap")
    @Scripts.Render("~/bundles/jqueryval")
    @RenderSection("scripts", required: false)

    <!-- Bootstrap JS necesario para dropdown -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const token = localStorage.getItem("token");
            const nombre = localStorage.getItem("nombre");

            const loginBtn = document.getElementById("btnLogin");
            const userDropdown = document.getElementById("userDropdown");
            const userName = document.getElementById("user-name");
            const logoutBtn = document.getElementById("btnLogout");

            function isTokenExpired(token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return Date.now() >= payload.exp * 1000;
                } catch {
                    return true;
                }
            }

            if (token && nombre && !isTokenExpired(token)) {
                // Usuario autenticado
                loginBtn.style.display = "none";
                userDropdown.style.display = "inline-block";
                userName.textContent = "Hola " + nombre;

                // Redirigir si está en login
                if (window.location.pathname.toLowerCase().includes("/login")) {
                    window.location.href = "/Home/Index";
                }
            } else {
                // Usuario no autenticado
                loginBtn.style.display = "inline-block";
                userDropdown.style.display = "none";
                localStorage.removeItem("token");
                localStorage.removeItem("nombre");
            }

            // Cerrar sesión
            logoutBtn?.addEventListener("click", function () {
                localStorage.removeItem("token");
                localStorage.removeItem("nombre");
                window.location.href = "/Home/Index";
            });
        });
    </script>

    <script src="https://bootstrapmade.com/assets/js/demo.js?v=106"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P7JSYB1CSP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-P7JSYB1CSP');
    </script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"68c5ca450bae485a842ff76066d69420","server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>

</body>
</html>
