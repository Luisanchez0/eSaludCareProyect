@{
    ViewBag.Title = "Historial Clínico | eSaludCare";
}

<div class="container mt-4">
    <h3 class="text-primary mb-4">🩺 Historial Clínico del Paciente (NOM-004-SSA3-2012)</h3>

    <div id="alerta" class="alert d-none"></div>

    <form id="formHistorialClinico">
        <input type="hidden" id="id_paciente" value="@ViewBag.IdPaciente" />
        <input type="hidden" id="id_medico" value="@ViewBag.IdMedico" />
        <input type="hidden" id="id_cita" value="@ViewBag.IdCita" />

        <!-- MOTIVO Y ANTECEDENTES -->
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-primary text-white fw-bold">Interrogatorio</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Motivo de consulta</label>
                    <textarea class="form-control" id="motivo_consulta" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Padecimiento actual</label>
                    <textarea class="form-control" id="padecimiento_actual" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Antecedentes personales</label>
                    <textarea class="form-control" id="antecedentes_personales" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Antecedentes familiares</label>
                    <textarea class="form-control" id="antecedentes_familiares" rows="2"></textarea>
                </div>
            </div>
        </div>

        <!-- EXPLORACIÓN FÍSICA -->
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-primary text-white fw-bold">Exploración Física</div>
            <div class="card-body row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Peso (kg)</label>
                    <input type="number" step="0.1" id="peso" class="form-control" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Talla (m)</label>
                    <input type="number" step="0.01" id="talla" class="form-control" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Presión arterial</label>
                    <input type="text" id="presion_arterial" class="form-control" placeholder="Ej: 120/80" />
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Frec. cardiaca (lpm)</label>
                    <input type="number" id="frecuencia_cardiaca" class="form-control" />
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Frec. respiratoria (rpm)</label>
                    <input type="number" id="frecuencia_respiratoria" class="form-control" />
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Temperatura (°C)</label>
                    <input type="number" step="0.1" id="temperatura" class="form-control" />
                </div>
                <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold">Exploración general</label>
                    <textarea class="form-control" id="exploracion_general" rows="2"></textarea>
                </div>
            </div>
        </div>

        <!-- DIAGNÓSTICO -->
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-primary text-white fw-bold">Diagnóstico y Tratamiento</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Diagnóstico</label>
                    <textarea class="form-control" id="diagnostico" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Pronóstico</label>
                    <textarea class="form-control" id="pronostico" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Tratamiento</label>
                    <textarea class="form-control" id="tratamiento" rows="3"></textarea>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-save me-2"></i> Guardar Historial Clínico
        </button>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const apiBase = "/api/v1/historial_clinico";

        $("#formHistorialClinico").on("submit", function (e) {
            e.preventDefault();
            guardarHistorialClinico();
        });

        function guardarHistorialClinico() {
            const data = {
                id_paciente: $("#id_paciente").val(),
                id_medico: $("#id_medico").val(),
                id_cita: $("#id_cita").val(),
                motivo_consulta: $("#motivo_consulta").val(),
                padecimiento_actual: $("#padecimiento_actual").val(),
                antecedentes_personales: $("#antecedentes_personales").val(),
                antecedentes_familiares: $("#antecedentes_familiares").val(),
                peso: $("#peso").val(),
                talla: $("#talla").val(),
                presion_arterial: $("#presion_arterial").val(),
                frecuencia_cardiaca: $("#frecuencia_cardiaca").val(),
                frecuencia_respiratoria: $("#frecuencia_respiratoria").val(),
                temperatura: $("#temperatura").val(),
                exploracion_general: $("#exploracion_general").val(),
                diagnostico: $("#diagnostico").val(),
                pronostico: $("#pronostico").val(),
                tratamiento: $("#tratamiento").val()
            };

            $.ajax({
                url: `${apiBase}/crear`,
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                success: function (resp) {
                    if (resp.success) {
                        mostrarAlerta("success", "Historial clínico guardado correctamente.");
                        $("#formHistorialClinico")[0].reset();
                    } else {
                        mostrarAlerta("error", "Error al guardar el historial clínico.");
                    }
                },
                error: function () {
                    mostrarAlerta("error", "Error de conexión con el servidor.");
                }
            });
        }

        function mostrarAlerta(tipo, mensaje) {
            const alerta = $("#alerta");
            alerta.removeClass("d-none alert-success alert-danger");

            if (tipo === "success") alerta.addClass("alert-success");
            else alerta.addClass("alert-danger");

            alerta.text(mensaje).fadeIn();
            setTimeout(() => alerta.fadeOut(), 3000);
        }
    </script>
}
